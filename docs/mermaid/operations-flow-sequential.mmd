%% Sequential flow: order verified against run_command → collector.run → builder.build → sink.write
%% Updated: 2026-02-28 — audit-57 refactor. Split modules (causal_lm, seq2seq, step_processor, baselines).
%% StepSummary replaces StepData. Per-request torch.Generator. Compound signals, calibration, consistency.
%% Ref: src/CoreVital/cli.py, instrumentation/{collector,causal_lm,seq2seq,step_processor,baselines}.py
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor':'#1e3a5f', 'primaryTextColor':'#e2e8f0', 'lineColor':'#60a5fa', 'clusterBkg':'#1e293b', 'clusterBorder':'#475569'}}}%%

flowchart LR
    Start([Start]) --> C1

    subgraph SG0["config_load"]
        direction LR
        C1[from_yaml or from_default] --> C2[CLI overrides]
    end

    C2 --> Log1

    subgraph SG0a["setup_logging"]
        Log1[setup_logging level format]
    end

    Log1 --> Col1

    subgraph SG0b["initialize collector"]
        Col1["InstrumentationCollector(config)"]
    end

    Col1 --> M1

    subgraph SG1["model_load (hf_loader.py)"]
        direction LR
        M1[_resolve_device] --> M2[_resolve_dtype] --> M3[AutoTokenizer] --> M4[pad_token] --> M5[AutoConfig] --> M6[ModelCapabilities] --> M8[from_pretrained] --> M9[model.to] --> M10[model.eval] --> M10a["_probe_attentions_available()"] --> M12[extract metadata]
    end

    M12 --> Gen1

    subgraph SG1a["per-request setup"]
        direction LR
        Gen1["torch.Generator(seed)<br/>(no global manual_seed)"] --> Assert1["assert batch_size == 1"] --> PLen["prompt_length < max_position_embeddings"]
    end

    PLen --> Tok1

    subgraph SG2["tokenize"]
        direction LR
        Tok1[tokenizer prompt] --> Tok2[.to device]
    end

    Tok2 --> PF1

    subgraph SG2a["baselines.run_prompt_forward()"]
        direction TB
        PF1{CausalLM or Seq2Seq?}
        PF2["model(input_ids)<br/>output_hidden_states, output_attentions"]
        PF3["extract sparse attention, basin scores,<br/>layer transforms, prompt surprisals"]
        PF4["Seq2Seq: reuse encoder outputs"]
        PF1 -->|CausalLM| PF2
        PF1 -->|Seq2Seq| PF4
        PF2 --> PF3
        PF4 --> PF3
    end

    PF3 --> I1

    subgraph SG3["model_inference (split modules)"]
        direction TB
        I1{CausalLM or Seq2Seq?}
        I2["causal_lm.run_causal_generation()<br/>model.generate()"]
        I3["seq2seq.run_seq2seq_generation()"]
        I3a["encoder_forward (.detach().cpu())"]
        I3b["decoder_loop (KV cache, HF LogitsProcessorList)"]
        I1 -->|CausalLM| I2
        I1 -->|Seq2Seq| I3
        I3 --> I3a --> I3b
    end

    I2 --> SP1
    I3b --> SP1

    subgraph SG3a["step_processor (per step)"]
        direction LR
        SP1["normalize_step_tensors()<br/>(strip embedding, slice attn, detach/cpu)"] --> SP2["process_step()<br/>(logits/attn/hidden summaries per layer)"] --> SP3["→ StepSummary (scalars only)<br/>raw tensors discarded"]
    end

    SP3 --> HF1

    subgraph SG4["health flags (post-generation)"]
        direction LR
        HF1["detect_repetition_loop<br/>(optional token_id_buffer)"] --> HF2["detect_mid_layer_anomaly<br/>(median baseline)"] --> HF3["aggregate: nan/inf + collapse<br/>(normalized < 0.03) + high_entropy"]
    end

    HF3 --> Rep2

    subgraph SG0c["initialize builder"]
        Rep2["ReportBuilder(config)"]
    end

    Rep2 --> R1

    subgraph SG5["report_build"]
        direction LR
        R1[trace_id] --> R2[model_info] --> R3[prompt_info] --> R4[generated_info]
        R4 --> R5["_build_timeline<br/>(from List~StepSummary~)"]
        R5 --> R6[_build_prompt_analysis]
        R5 --> R7[_build_health_flags]
        R6 --> R8[Summary]
        R7 --> R8
        R8 --> R11["assemble Report v0.4.0"]
    end

    R11 --> Ext1

    subgraph SG5c["compute extensions (interpretation layer)"]
        direction TB
        Ext1["detect_compound_signals()"] --> Ext2["compute_risk_score() (composite)<br/>+ compute_layer_blame() (enriched)<br/>+ compute_layer_blame_flat()"]
        Ext2 --> Ext3["compute_fingerprint_vector() (25-elem v2)<br/>+ compute_prompt_hash()"]
        Ext3 --> Ext4["compute_early_warning()<br/>(5 trend detectors, profile threshold)"]
        Ext4 --> Ext5["build_narrative()<br/>(data-specific: values, steps, tokens, recommendations)"]
        Ext5 --> Ext6["calibration: load profile + compute_divergence_score<br/>(if calibration_profile configured)"]
        Ext6 --> Ext7["validate_metric_consistency<br/>(if DEBUG logging)"]
        Ext7 --> Ext8["on_risk: attach full layers if triggered"]
        Ext8 --> Ext9["RAG context if provided"]
    end

    Ext9 --> Perf1

    subgraph SG5b["inject performance if --perf"]
        direction LR
        Perf1[mark_run_end] --> Perf2[build_summary_dict] --> Perf3[extensions.performance]
    end

    Perf3 --> Sink1

    subgraph SG5a["sink write"]
        direction LR
        Sink1{sink type?}
        Sink1 -->|sqlite| Sink2[SQLiteSink]
        Sink1 -->|local_file| Sink3[LocalFileSink]
        Sink1 -->|datadog| Sink4[DatadogSink]
        Sink1 -->|prometheus| Sink5[PrometheusSink]
        Sink1 -->|wandb| Sink6[WandBSink]
    end

    Sink2 --> Otel1
    Sink3 --> Otel1
    Sink4 --> Otel1
    Sink5 --> Otel1
    Sink6 --> Otel1

    subgraph SG8["optional: OpenTelemetry export"]
        direction LR
        Otel1{export_otel?}
        Otel1 -->|yes| Otel2[export_run_to_otel OTLP]
        Otel1 -->|no| Cleanup
        Otel2 --> Cleanup
    end

    subgraph SG9["cleanup"]
        Cleanup["torch.cuda.empty_cache()<br/>(in finally block)"]
    end

    Cleanup --> End([End])

    style Start fill:#059669
    style End fill:#059669
    style C1 fill:#1e40af
    style C2 fill:#1e40af
    style Log1 fill:#1e40af
    style Col1 fill:#1e40af
    style Rep2 fill:#92400e
    style M1 fill:#065f46
    style M6 fill:#065f46
    style M10a fill:#065f46
    style M12 fill:#065f46
    style Gen1 fill:#065f46
    style Assert1 fill:#065f46
    style PLen fill:#065f46
    style Tok1 fill:#065f46
    style Tok2 fill:#065f46
    style I1 fill:#5b21b6
    style I2 fill:#5b21b6
    style I3 fill:#5b21b6
    style I3a fill:#5b21b6
    style I3b fill:#5b21b6
    style SP1 fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style SP2 fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style SP3 fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style HF1 fill:#831843,stroke:#f472b6,color:#fbcfe8
    style HF2 fill:#831843,stroke:#f472b6,color:#fbcfe8
    style HF3 fill:#831843,stroke:#f472b6,color:#fbcfe8
    style R1 fill:#92400e
    style R5 fill:#92400e,stroke:#f59e0b,color:#fde68a
    style R7 fill:#831843,stroke:#f472b6,color:#fbcfe8
    style R11 fill:#92400e
    style Ext1 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext2 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext3 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext4 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext5 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext6 fill:#065f46,stroke:#10b981,color:#6ee7b7
    style Ext7 fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style Ext8 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Ext9 fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style PF1 fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style PF2 fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style PF3 fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style PF4 fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style Perf1 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Perf2 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Perf3 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink1 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink2 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink3 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink4 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink5 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Sink6 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Cleanup fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Otel1 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Otel2 fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style SG0 fill:#1e40af15
    style SG0a fill:#1e40af15
    style SG0b fill:#1e40af15
    style SG0c fill:#92400e15
    style SG1 fill:#065f4615
    style SG1a fill:#065f4615
    style SG2 fill:#065f4615
    style SG2a fill:#7c2d1215
    style SG3 fill:#5b21b615
    style SG3a fill:#14532d15
    style SG4 fill:#83184315
    style SG5 fill:#92400e15
    style SG5a fill:#0e749015
    style SG5b fill:#0e749015
    style SG5c fill:#4c1d9515
    style SG8 fill:#0e749015
    style SG9 fill:#0e749015
