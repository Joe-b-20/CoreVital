%% CoreVital Computation Pipeline: WHERE and WHEN each metric is computed
%% Shows the collector flow with split modules (causal_lm, seq2seq, step_processor, baselines).
%% Color key: ğŸ”µ Orchestrator | ğŸŸ¢ Step Processor | ğŸŸ  Prompt Telemetry | ğŸ”´ Health Flags | ğŸŸ¡ Extensions
%% Updated: 2026-02-28 â€” audit-57 refactor. Split modules, StepSummary, per-request Generator.
%% Ref: src/CoreVital/instrumentation/{collector,causal_lm,seq2seq,step_processor,baselines}.py
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor':'#1e3a5f', 'primaryTextColor':'#e2e8f0', 'lineColor':'#60a5fa', 'clusterBkg':'#1e293b', 'clusterBorder':'#475569'}}}%%

flowchart TB

    Start([collector.run]) --> Guards

    %% â”€â”€â”€ GUARDS & SETUP â”€â”€â”€
    subgraph SG_Guards["Collector Guards & Setup"]
        Guards["batch_size == 1 assertion<br/>prompt_length < max_position_embeddings<br/>per-request torch.Generator (no global seed)<br/>try/finally with cuda.empty_cache"]
    end

    Guards --> LoadModel

    subgraph SG_Load["model_load (hf_loader.py)"]
        LoadModel["Load model + tokenizer<br/>ModelCapabilities.from_config<br/>_probe_attentions_available()"]
    end

    LoadModel --> TypeCheck

    TypeCheck{CausalLM or Seq2Seq?}

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CAUSAL LM PATH â€” causal_lm.py
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    TypeCheck -->|CausalLM| BeamCheck_C

    subgraph SG_CausalLM["causal_lm.py â€” CausalLM Generation"]
        direction TB
        BeamCheck_C{"num_beams > 1 AND<br/>hidden/attention capture?"}
        BeamCheck_C -->|yes| BeamErr["Raise InstrumentationError"]
        BeamCheck_C -->|no| PromptFwd_C

        PromptFwd_C["baselines.run_prompt_forward()<br/>model(input_ids)<br/>â†’ sparse attention, basin scores,<br/>layer transforms, prompt surprisals"]

        PromptFwd_C --> Generate_C

        Generate_C["model.generate()<br/>output_scores, output_hidden_states,<br/>output_attentions"]

        Generate_C --> PerStep_C["For each step:<br/>normalize_step_tensors()<br/>â†’ process_step()<br/>â†’ StepSummary (scalars only)"]

        PerStep_C --> Warnings_C["_collect_warnings()"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% SEQ2SEQ PATH â€” seq2seq.py
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    TypeCheck -->|Seq2Seq| Encoder_S

    subgraph SG_Seq2Seq["seq2seq.py â€” Seq2Seq Generation"]
        direction TB
        Encoder_S["Encode input<br/>output_hidden_states, output_attentions<br/>.detach().cpu() encoder outputs"]

        Encoder_S --> PromptFwd_S["Reuse encoder outputs<br/>â†’ sparse attention, basin scores,<br/>layer transforms, prompt surprisals"]

        PromptFwd_S --> DecoderLoop["Manual decoder loop (with KV cache)<br/>_build_logits_processor() for sampling<br/>_normalize_eos() for EOS set"]

        DecoderLoop --> PerStep_S["Each step immediately:<br/>normalize_step_tensors()<br/>â†’ process_step()<br/>â†’ StepSummary<br/>Raw tensors never accumulate"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PER-STEP PROCESSING â€” step_processor.py
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    PerStep_C --> SG_StepProc
    PerStep_S --> SG_StepProc

    subgraph SG_StepProc["step_processor.py â€” Per-Step Pipeline"]
        direction TB

        NormStep["normalize_step_tensors()<br/>Strip embedding (hidden[1:])<br/>Slice attention to last query<br/>.detach().cpu() all tensors<br/>Shape assertions (3D/4D)"]

        NormStep --> ProcessStep["process_step()"]

        subgraph SG_Logit["summaries/logits.py"]
            direction LR
            L1["entropy (full or topk_approx)"]
            L2["top_k_margin, topk_mass"]
            L3["topk_probs"]
            L4["perplexity (2^entropy)"]
            L5["surprisal (-logâ‚‚ p_actual)"]
        end

        subgraph SG_Attn_Step["summaries/attention.py"]
            direction LR
            A1["entropy_mean + entropy_mean_normalized<br/>collapsed/focused counts<br/>(clamp-based log, division normalization)"]
            A2["concentration_max/min"]
        end

        subgraph SG_Hidden_Step["summaries/hidden_states.py"]
            direction LR
            H1["L2 norm, Std, Mean, max_abs"]
            H1a["clip_fraction, clip_max_before<br/>(when clipping fires)"]
        end

        subgraph SG_Anomaly_Step["NaN/Inf Detection"]
            N1["detect_tensor_anomalies()"]
        end

        subgraph SG_Buffer["Repetition Buffer"]
            B1["Extract _last_layer_hidden_vec<br/>(small 1-D CPU vector for repetition)"]
        end

        ProcessStep --> SG_Logit
        ProcessStep --> SG_Attn_Step
        ProcessStep --> SG_Hidden_Step
        ProcessStep --> SG_Anomaly_Step
        ProcessStep --> SG_Buffer

        SG_Logit --> Discard
        SG_Attn_Step --> Discard
        SG_Hidden_Step --> Discard
        SG_Anomaly_Step --> Discard
        SG_Buffer --> Discard

        Discard["Raw tensors discarded<br/>â†’ StepSummary (scalars only)"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% POST-GENERATION: HEALTH FLAGS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Discard --> PostGen

    subgraph SG_Health["Health Flag Post-Processing"]
        direction TB
        PostGen["All steps complete<br/>List~StepSummary~ timeline"]
        PostGen --> Rep["detect_repetition_loop<br/>cosine sim > 0.9995, 3+ consecutive<br/>(optional token_id_buffer cross-check)"]
        PostGen --> Mid["detect_mid_layer_anomaly<br/>median early-layer L2 baseline"]
        PostGen --> Agg["Aggregate flags<br/>nan/inf + collapse (normalized < 0.03)<br/>+ high_entropy_steps (profile threshold)"]
        Rep --> HF["HealthFlags"]
        Mid --> HF
        Agg --> HF
    end

    HF --> BuildReport

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% REPORT BUILD & EXTENSIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph SG_Report["Report Build"]
        BuildReport["ReportBuilder.build()<br/>Schema v0.4.0"]
        BuildReport --> AttachPrompt["Attach prompt_analysis"]
        BuildReport --> AttachHealth["Attach health_flags"]
        AttachPrompt --> BuildExt
        AttachHealth --> BuildExt
    end

    subgraph SG_Extensions["Extensions Computation"]
        direction TB
        BuildExt["Report assembled"]
        BuildExt --> CompSig["compound_signals.detect_compound_signals()"]
        BuildExt --> Risk["risk.compute_risk_score() (composite)<br/>+ compute_layer_blame() (enriched)<br/>+ compute_layer_blame_flat()"]
        CompSig --> Risk
        BuildExt --> Fingerprint["fingerprint: 25-element v2 vector<br/>+ prompt_hash, version: 2"]
        BuildExt --> EarlyWarn["early_warning: 5 trend detectors<br/>(profile threshold)"]
        Risk --> Narrative["narrative: data-specific text<br/>with step indices, token text,<br/>compound signals, recommendations"]
        EarlyWarn --> Narrative
        CompSig --> Narrative
        Narrative --> Calibration["calibration: divergence_score<br/>(if profile configured)"]
        Calibration --> Consistency["metric_consistency: validate<br/>(if DEBUG logging)"]
        Consistency --> OnRisk{"on_risk triggered?"}
        OnRisk -->|yes| AttachFull["Attach full timeline layers"]
        OnRisk -->|no| SkipFull["Keep summary mode"]
        AttachFull --> FinalReport
        SkipFull --> FinalReport
        Fingerprint --> FinalReport
    end

    FinalReport --> SinkWrite

    subgraph SG_Sink["Sink Write"]
        SinkWrite{sink type?}
        SinkWrite -->|sqlite| SQLite["SQLiteSink"]
        SinkWrite -->|local| LocalFile["LocalFileSink"]
        SinkWrite -->|datadog| Datadog["DatadogSink"]
        SinkWrite -->|prometheus| Prom["PrometheusSink"]
        SinkWrite -->|wandb| WandB["WandBSink"]
    end

    SQLite --> Done([Done])
    LocalFile --> Done
    Datadog --> Done
    Prom --> Done
    WandB --> Done

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    style Start fill:#059669,color:#d1fae5
    style Done fill:#059669,color:#d1fae5

    style SG_Guards fill:#1e3a5f15,stroke:#60a5fa
    style Guards fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style SG_Load fill:#1e3a5f15,stroke:#60a5fa
    style LoadModel fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style TypeCheck fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd

    style SG_CausalLM fill:#1e3a5f15,stroke:#60a5fa
    style BeamCheck_C fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style BeamErr fill:#7f1d1d,stroke:#f87171,color:#fecaca
    style PromptFwd_C fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style Generate_C fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style PerStep_C fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style Warnings_C fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd

    style SG_Seq2Seq fill:#1e3a5f15,stroke:#60a5fa
    style Encoder_S fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style PromptFwd_S fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style DecoderLoop fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style PerStep_S fill:#14532d,stroke:#4ade80,color:#bbf7d0

    style SG_StepProc fill:#14532d15,stroke:#4ade80
    style NormStep fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style ProcessStep fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style Discard fill:#92400e,stroke:#f59e0b,color:#fde68a

    style SG_Logit fill:#312e8115,stroke:#818cf8
    style L1 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style L2 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style L3 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style L4 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style L5 fill:#312e81,stroke:#818cf8,color:#c7d2fe

    style SG_Attn_Step fill:#7c2d1215,stroke:#fb923c
    style A1 fill:#7c2d12,stroke:#fb923c,color:#fed7aa
    style A2 fill:#7c2d12,stroke:#fb923c,color:#fed7aa

    style SG_Hidden_Step fill:#14532d15,stroke:#4ade80
    style H1 fill:#14532d,stroke:#4ade80,color:#bbf7d0
    style H1a fill:#14532d,stroke:#4ade80,color:#bbf7d0

    style SG_Anomaly_Step fill:#7f1d1d15,stroke:#f87171
    style N1 fill:#7f1d1d,stroke:#f87171,color:#fecaca

    style SG_Buffer fill:#83184315,stroke:#f472b6
    style B1 fill:#831843,stroke:#f472b6,color:#fbcfe8

    style SG_Health fill:#83184315,stroke:#f472b6
    style PostGen fill:#831843,stroke:#f472b6,color:#fbcfe8
    style Rep fill:#831843,stroke:#f472b6,color:#fbcfe8
    style Mid fill:#831843,stroke:#f472b6,color:#fbcfe8
    style Agg fill:#831843,stroke:#f472b6,color:#fbcfe8
    style HF fill:#831843,stroke:#f472b6,color:#fbcfe8

    style SG_Report fill:#92400e15,stroke:#f59e0b
    style BuildReport fill:#92400e,stroke:#f59e0b,color:#fde68a
    style AttachPrompt fill:#92400e,stroke:#f59e0b,color:#fde68a
    style AttachHealth fill:#92400e,stroke:#f59e0b,color:#fde68a
    style SG_Extensions fill:#4c1d9515,stroke:#a78bfa
    style BuildExt fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CompSig fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Risk fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Fingerprint fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style EarlyWarn fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Narrative fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style Calibration fill:#065f46,stroke:#10b981,color:#6ee7b7
    style Consistency fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
    style OnRisk fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style AttachFull fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style SkipFull fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style FinalReport fill:#92400e,stroke:#f59e0b,color:#fde68a

    style SG_Sink fill:#0e749015,stroke:#22d3ee
    style SinkWrite fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style SQLite fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style LocalFile fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Datadog fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style Prom fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
    style WandB fill:#0e7490,stroke:#22d3ee,color:#a5f3fc
