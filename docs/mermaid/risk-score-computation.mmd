%% Risk Score Computation â€” How the composite 0â€“1 risk score is built
%% Three layers of evidence are combined: boolean flags, continuous metrics, compound signals.
%% Ref: src/CoreVital/risk.py â†’ compute_risk_score()
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor':'#1e3a5f', 'primaryTextColor':'#e2e8f0', 'lineColor':'#60a5fa', 'clusterBkg':'#1e293b', 'clusterBorder':'#475569'}}}%%

flowchart TB

    Input(["Inputs:<br/>health_flags, timeline,<br/>layers_by_step, compound_signals"])

    %% Layer 1: Boolean flags
    subgraph L1["LAYER 1: Boolean Health Flags (hard ceilings via max)"]
        direction TB
        F1["NaN/Inf detected<br/>â†’ 1.0 (catastrophic, return immediately)"]
        F2["Repetition loop<br/>â†’ 0.9"]
        F3["Mid-layer anomaly<br/>â†’ 0.7"]
        F4["Attention collapse<br/>â†’ 0.15"]
        FMax["boolean_floor = max(triggered flags)"]
        F1 --> FMax
        F2 --> FMax
        F3 --> FMax
        F4 --> FMax
    end

    %% Layer 2: Continuous metrics
    subgraph L2["LAYER 2: Continuous Timeline Metrics (additive components)"]
        direction TB
        C1["Elevated entropy<br/>min(1, mean_ent / 8) Ã— 0.3<br/>threshold > 0.05"]
        C2["Entropy rising trend<br/>lastâ…“ > firstâ…“ Ã— 1.3<br/>min(0.2, delta/first Ã— 0.1)"]
        C3["Low confidence margin<br/>max(0, 1 - mean_margin Ã— 5) Ã— 0.2<br/>threshold > 0.05"]
        C4["Low top-K mass<br/>max(0, 1 - mean_mass) Ã— 0.15<br/>threshold > 0.03"]
        C5["Elevated surprisal<br/>min(0.1, mean_surprisal / 10)<br/>threshold > 0.02"]
        CSum["continuous_sum = Î£ components"]
        C1 --> CSum
        C2 --> CSum
        C3 --> CSum
        C4 --> CSum
        C5 --> CSum
    end

    %% Layer 3: Compound signals
    subgraph L3["LAYER 3: Compound Signals (severity-based)"]
        direction TB
        CS1["context_loss â†’ severity 0.75"]
        CS2["confident_confusion â†’ severity 0.5"]
        CS3["degenerating_generation â†’ severity 0.7"]
        CS4["attention_bottleneck â†’ severity 0.65"]
        CS5["confident_repetition_risk â†’ severity 0.4"]
        CSSum["compound_sum = Î£ fired severities"]
        CS1 --> CSSum
        CS2 --> CSSum
        CS3 --> CSSum
        CS4 --> CSSum
        CS5 --> CSSum
    end

    %% Final computation
    subgraph FINAL["FINAL SCORE"]
        direction TB
        Combine["score = boolean_floor + continuous_sum + compound_sum<br/>(boolean flags via max, rest additive)"]
        Cap["risk_score = min(1.0, score)"]
        Factors["risk_factors = list of all contributors<br/>(e.g. elevated_entropy, compound:context_loss)"]
        Combine --> Cap
        Cap --> Factors
    end

    %% Interpretation
    subgraph INTERP["INTERPRETATION"]
        direction LR
        I1["< 0.3<br/>Low risk âœ…"]
        I2["0.3 â€“ 0.7<br/>Moderate âš ï¸"]
        I3["> 0.7<br/>High risk ðŸ”´"]
    end

    Input --> L1
    Input --> L2
    Input --> L3

    FMax --> FINAL
    CSum --> FINAL
    CSSum --> FINAL

    Factors --> INTERP

    %% Legacy fallback note
    Legacy["Legacy fallback: when no timeline,<br/>compute_risk_score_legacy() uses<br/>boolean flags only"]

    %% Styling
    style Input fill:#059669,stroke:#10b981,color:#d1fae5

    style L1 fill:#7f1d1d15,stroke:#f87171
    style F1 fill:#7f1d1d,stroke:#f87171,color:#fecaca
    style F2 fill:#7f1d1d,stroke:#f87171,color:#fecaca
    style F3 fill:#7f1d1d,stroke:#f87171,color:#fecaca
    style F4 fill:#713f12,stroke:#f59e0b,color:#fde68a
    style FMax fill:#831843,stroke:#f472b6,color:#fbcfe8

    style L2 fill:#312e8115,stroke:#818cf8
    style C1 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style C2 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style C3 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style C4 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style C5 fill:#312e81,stroke:#818cf8,color:#c7d2fe
    style CSum fill:#312e81,stroke:#818cf8,color:#c7d2fe

    style L3 fill:#4c1d9515,stroke:#a78bfa
    style CS1 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CS2 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CS3 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CS4 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CS5 fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe
    style CSSum fill:#4c1d95,stroke:#a78bfa,color:#ddd6fe

    style FINAL fill:#92400e15,stroke:#f59e0b
    style Combine fill:#92400e,stroke:#f59e0b,color:#fde68a
    style Cap fill:#92400e,stroke:#f59e0b,color:#fde68a
    style Factors fill:#92400e,stroke:#f59e0b,color:#fde68a

    style INTERP fill:#0f172a,stroke:#334155
    style I1 fill:#065f46,stroke:#10b981,color:#6ee7b7
    style I2 fill:#713f12,stroke:#f59e0b,color:#fde68a
    style I3 fill:#7f1d1d,stroke:#f87171,color:#fecaca

    style Legacy fill:#1e3a5f,stroke:#60a5fa,color:#93c5fd
